name: Update Last Commit Badge

on:
  schedule:
    - cron: '0 * * * *'  # Runs every hour
  workflow_dispatch:

jobs:
  update-badge:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Get latest commit timestamp
      uses: actions/github-script@v7
      id: get_latest
      with:
        script: |
          const repos = await github.paginate(
            github.rest.repos.listForUser,
            { username: 'Jianningli', per_page: 100 }
          );

          let latest = 0;
          for (const repo of repos) {
            const commits = await github.rest.repos.listCommits({
              owner: 'Jianningli',
              repo: repo.name,
              per_page: 1
            }).catch(() => ({ data: [] }));

            if (commits.data.length > 0) {
              const ts = new Date(commits.data[0].commit.committer.date).getTime();
              if (ts > latest) latest = ts;
            }
          }

          const latestDate = new Date(latest).toISOString().split('T')[0];
          core.setOutput('latest_date', latestDate);

    - name: Generate badge
      run: |
        LATEST_DATE=${{ steps.get_latest.outputs.latest_date }}
        echo "<svg xmlns='http://www.w3.org/2000/svg' width='150' height='20'>
        <rect width='150' height='20' fill='#555'/>
        <rect x='80' width='70' height='20' fill='#4c1'/>
        <text x='40' y='14' fill='#fff' font-family='Verdana' font-size='11'>Last Commit</text>
        <text x='85' y='14' fill='#fff' font-family='Verdana' font-size='11'>$LATEST_DATE</text>
        </svg>" > last-commit-badge.svg

    - name: Commit and push badge
      uses: stefanzweifel/git-auto-commit-action@v4
      with:
        commit_message: "Update last commit badge"
        file_pattern: last-commit-badge.svg
